# swot-mission-validation-sub100km
This repository contains the code and data necessary to reproduce the analyses and figures presented in Wang et al. (2025).

In Wang et al. (2025), we conducted a validation analysis of sea surface height measurements obtained from the Ka-Band Interferometer (KaRIn) radar aboard the Surface Water and Ocean Topography (SWOT) mission satellite. SWOT is a pioneering mission that utilizes KaRIn for the first time to map the elevation of water surfaces, including both inland and oceanic waters. The mission's primary strength lies in its high precision and its wide-swath coverage of 120 km, with a 20 km gap at nadir. The mission's objectives for oceanography include measuring sea surface height for wavelengths under approximately 100 km in two dimensions. This documentation describes the validation process for the mission.

For validation, we used ground truth data derived from conventional in-situ mooring platforms and confirmed that KaRIn exceeded the mission's science requirements by at least a factor of four.

This code is designed to reproduce all the analyses and figures presented in the paper using published campaign data hosted by PO.DAAC. The analysis is divided into five main steps carried out by five main scripts:

- [0.plot_figure1.py](#plot-figure-1) produces the Figure 1. 
- [1.0.density_all_moorings_gliders_level-2.py](#calculate-density-anomaly) calculates density from temperature and salinity, derives density anomalies from the mean profile derived from S moorings, and saves all density into one netCDF file.  
- [2.0.calculate_steric_height.py](#calculate-steric-height) calculates steric height from density anomaly profiles generated by step 1.0. 
- [3.0.colocate.steric.karin.py](#colocate-steric-and-karin) colocates KaRIn and mooring with tunable parameters. 
- [4.0.process.colocated.data.py](#statistics) processes colocated data pairs and produces statiscal analyses and plots. 
- [5.0.wavenumber_spectrum.py](#wavenumber-spectrum) use the processed data pairs and conduct the wavenumber analysis. 

## Plot Figure 1
Create Figure 1. Campaign and mooring locations on a background of SSHA from NeurOST and SWOT KaRIn. 

### Input Data Files

Place the following data files in the `data/` directory:

- **NeurOST SSHA Data**: `NeurOST_SSH-SST_20230403_20240722.nc`
- **SWOT SSHA Data**:
  - `SWOT_L2_LR_SSH_2.0_combined_calval_orbit_pass_013_sub_lat-30-40.nc`
  - `SWOT_L2_LR_SSH_2.0_combined_calval_orbit_pass_026_sub_lat-30-40.nc`
- **Mooring Positions**: `mooring_positions.csv`

These data can be downloaded from the paper page on AGU website. 

### Directory Structure

```markdown
   .
   ├── data/
   │   ├── NeurOST_SSH-SST_20230403_20240722.nc
   │   ├── SWOT_L2_LR_SSH_2.0_combined_calval_orbit_pass_013_sub_lat-30-40.nc
   │   ├── SWOT_L2_LR_SSH_2.0_combined_calval_orbit_pass_026_sub_lat-30-40.nc
   │   └── mooring_positions.csv
   ├── figures/
   │   ├── figure1_locations.png
   │   └── figure1_locations_zoom.png
   ├── utils.py
   └── main_script.py
```

### Usage


1. Ensure the input data files are in the `data/` directory.
2. Run the script to process the data and generate visualizations:

```bash
   python 0.plot_figure1.py
```

3. The output figures are saved in the `figures/` directory:
   - `figure1_locations.png`: Regional map with SSHA data and mooring positions.
   - `figure1_locations_zoom.png`: Zoomed-in map for details of the mooring positions.

4. Use photo editor such as Gimp to create the Figure 1 in Wang et al. (2025)

## Calculate density anomaly
1.0.density_all_moorings_gliders_level-2.py
This script calculates the density from moorings and gliders, combines them into one file, removes outliers, and saves the resulting data.

### Input

* `path_input`: a directory path containing input files (e.g., netCDF files). The relative path should be `../data/`.
* `fn`: the output file name for the combined dataset
* Optional parameters:
	+ `do_moorings`: boolean flag to indicate whether to process mooring data (default: True)
	+ `do_remove_outliers`: boolean flag to indicate whether to remove outliers from the data (default: False)

### Process

1. **Moorings**
	* Open input files and extract relevant variables (temperature, salinity, pressure, density)
	* Calculate seawater density using the `c_rho` function
	* Create a new dataset with the calculated densities
2. **Gliders**
	* Open input files and extract relevant variables (pressure, temperature, salinity, density)
	* Apply outlier removal to each profiler on each mooring (using the `remove_outliers` function)
3. **Removing Outliers**
	* Apply a 5-sigma rule to detect outliers in the density data at each depth with 5-m bin size. 
4. **Combining Data**
	* Combine the processed mooring and glider data into a single dataset using the `xr.Dataset` class
5. **Saving Output**
	* Save the combined dataset to disk as a new netCDF file (`fn_out`)

### Output

* A single netCDF file containing all processed data, including:
	+ Moorings
	+ Gliders (with outlier removal)
* Optional: the original mooring and glider datasets are saved separately.

## Calculate Steric Height 
- **2.0.calculate_steric_height.py**

This script calculates the steric height from the density anomaly profiles from moorings and gliders. It uses various functions to process the data, remove spikes, and calculate the steric height.

### Modules Used

* `xarray` for handling netCDF files
* `numpy` for numerical computations
* `pandas` for data manipulation and analysis
* `matplotlib.pyplot` for plotting (not used in this script)
* `gsw` for calculating density from pressure
* `tqdm` for displaying progress bars

### Functions Used

* `despike_profile(x, y, sigma=5)`: removes spikes from a profile
* `remove_spikes(df, sigma=5, varname='steric')`: removes spikes from a time series in a pandas DataFrame
* `calculate_steric_height_from_profile(depth, density, time, integration_depth=[-500, 0], ...)`:
	+ calculates the steric height from a profile
	+ uses the `despike_profile` function to remove spikes
	+ uses the `remove_spikes` function to remove spikes from the data
* `process_glider(glider_name, ...)`: processes glider data and returns a pandas DataFrame with the steric height
* `calculate_mooring_steric(time, data, mooring_name, ...)`: calculates the steric height from a mooring profile
* `remove_spikes(df)` (called by `calculate_mooring_steric`): removes spikes from a time series in a pandas DataFrame

### Main Script

The main script sets up various parameters for calculating the steric height, processes gliders and moorings using these parameters, and saves the results to CSV files.

### Parameters Used

* `integration_depth=[-500, 0]`: depth range for steric height calculation
* `max_spacing=10`: minimum gap threshold for identifying a good profile
* `time_span_minimum=10 * 60`: minimum time span for steric height calculation
* `time_span_maximum=120 * 60`: maximum time span for steric height calculation
* `rho0=1027.5`: density at sea level
* `surface_time_depth=-100`: depth range between surface_time_depth and surface used to estimate mean time
* `bottom_boundary_tolerance=10`: maximum depth gap on the edge of profiles at the bottom
* `top_boundary_tolerance=10`: maximum depth gap on the edge of profiles at the top
* `surface_depth=-8`: the depth of the surface layer, in which density will be replaced by the median of the layer


The paper used the following parameters:

```markdown
integration_depth=[-500, 0]
max_spacing=10
bottom_boundary_tolerance=80
top_boundary_tolerance=10
surface_depth=-8
```

### Output

The script saves the results to CSV files following the format:

* `../data/rutgers/ru32_ru38_steric_heights_depth_{-integration_depth[0]:3d}.csv`
* `../data/mooring.data/all_mooring_steric_heights_depth_{-integration_depth[0]:3d}.csv`

These files contain the steric height and other information for each glider and mooring. The following shows a snippet of the csv data file. 

| **Column Name** | **Data Type** | **Description** |
| --- | --- | --- |
| `lat` | float64 | Latitude values |
| `lon` | float64 | Longitude values |
| `time_min` | int64 | Minimum time values, seconds since 2023-01-01 |
| `time_max` | int64 | Maximum time values, seconds since 2023-01-01 |
| `surface_time` | int64 | Surface time values, seconds since 2023-01-01 |
| `depth_min` | float64 | Minimum depth values |
| `depth_max` | float64 | Maximum depth values |
| `num_points` | int64 | Number of points in each profile |
| `steric` | float64 | Steric height values (in meters) |
| `Mooring_ID` | object | Mooring ID values |

#### Sample Data


| lat  | lon   | time_min | time_max | surface_time | depth_min | depth_max | num_points | steric | Mooring_ID |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 36.1798 | -125.1268 | 5354727.0000 | 5355523.5000 | 5355434.0000 | -494.8176 | -4.2868 | 1593.0000 | 52.9755 | S1 |
| 36.1813 | -125.1264 | 5356514.5000 | 5357263.5000 | 5357178.0000 | -496.2219 | -4.7206 | 1494.0000 | 52.1012 | S1 |
| 36.1825 | -125.1261 | 5358204.5000 | 5358941.0000 | 5358857.0000 | -495.5951 | -4.6571 | 1472.0000 | 52.1746 | S1 |
| ...   | ...   | ...       | ...      | ...        | ...     | ...    | ...     | ...    | S1 |
| 36.1841 | -125.1265 | 5363242.0000 | 5363984.0000 | 5363897.0000 | -496.2865 | -4.4438 | 1486.0000 | 50.5210 | S1 |


## Colocate Steric and KaRIn
- **3.0.colocate.steric.karin.py**

This Python script performs the co-location of steric height data from moorings and gliders with SWOT Karin data. 
It includes data cleaning, subsetting, interpolation, and saving the output 
in a structured format.

### The script does the follwing
1. **Cleans and pre-processes steric data**: Removes missing values and sorts by time.
2. **Loads SWOT Karin data**: Reads data within specified latitude and time ranges, and applies masks to remove bad data.
3. **Interpolates steric data**: Aligns steric height data with SWOT Karin data spatially and temporally.
4. **Handles multiple passes**: Supports processing for specific SWOT orbit passes.
5. **Exports results**: Saves the co-located data to a CSV file using Pandas.

### Key Functions

**mask_bad_karin(kk)**

- Removes bad SWOT Karin data based on RMS (Root Mean Square) values.
- Plots the RMS values and displays the data for visual inspection.

**colocate(karin_fn, steric)**

- **Inputs**:
  - `karin_fn`: Path to the SWOT Karin data file.
  - `steric`: Steric height dataset from moorings and gliders. These data are produced by [2.0.calculate_steric_height.py](#calculate-steric-height).

- **Process**:
  1. Filters steric data to remove missing values. 
  2. Loads SWOT data and subsets it by latitude and time.
  3. Interpolates steric height data to SWOT Karin data's spatial and temporal resolution.
  4. Handles individual mooring IDs and interpolates data for each.

- **Output**:
  - A concatenated DataFrame of co-located data for all moorings and gliders.

Example:
.. csv-table::
   :header: "time_karin", "lon", "lat", "time_delta_left", "time_delta_right", "ssha_karin", "steric", "steric_linear", "swh", "pass_num", "mooring_id"
   :delim: " "

   7892017.00000, -125.12200, 36.18640, -31.41667, 0.80000, 2.66830, 53.52230, 53.50677, 1.24138, 13.00000, S1
   7892017.00000, -125.06420, 36.02310, -96.28333, 39.55000, 2.04051, 53.81200, 53.37129, 1.22698, 13.00000, P2
   7892017.00000, -125.04440, 35.92050, -0.76667, 34.83333, 0.94318, 52.66940, 52.68147, 1.21972, 13.00000, S2
   7892017.00000, -125.03470, 35.84670, -24.30000, 41.03333, -0.74081, 51.67370, 52.04385, 1.21670, 13.00000, P3
   7892017.00000, -124.98000, 35.65570, -9.26667, 27.68333, -3.10693, 52.23950, 52.20572, 1.19866, 13.00000, S3



### Main Script 

- **Integration Depth**: Defined as command-line arguments specifying the depth range for steric height integration. The paper used 0 -500, meaning the integration depth for the steric height calculation is surface to 500 meters.

- **Mooring and Glider Data**:
  - Read from CSV files (`fn_mooring`, `fn_glider`) generated by the second step [2.0.calculate_steric_height.py](#calculate-steric-height).

- **SWOT Karin Data**:
  - Processed for two specific passes (`013` and `026`) within a latitude range.
  - The data are located in ../data/
  - '../data/SWOT_L2_LR_SSH_2.0_combined_calval_orbit_pass_013_sub_lat-30-40.nc'
  - '../data/SWOT_L2_LR_SSH_2.0_combined_calval_orbit_pass_026_sub_lat-30-40.nc'

- **Data Cleaning**:
  - Filters the co-located data to remove missing or invalid entries.

- **Output**:
  - Saves the cleaned, co-located data to a CSV file with specified formatting.

Example Usage
-------------

.. code-block:: bash

   python 3.0.colocate.steric.karin.py 0 -500

Output
------

The final co-located data is saved in a CSV file, with the following columns:

- `time_karin`: Timestamp of SWOT data.
- `lon`, `lat`: Longitude and latitude of the co-located data point (from moorings).
- `time_delta_left`, `time_delta_right`: Time separation between SWOT pass and available steric data before (time_delta_left) and after (time_delta_right) the SWOT pass time.
- `ssha_karin`: colocated SWOT sea surface height anomaly.
- `steric`, `steric_linear`: Steric height from moorings or gliders (nearest and linear interpolations), with quality control using time_delta values to exclude separations over 100 minutes on either side.
- `swh`: Significant wave height.
- `pass_num`: SWOT orbit pass number.
- `mooring_id`: Mooring or glider identifier ['S1','P1','P2','S2','P3','P4','S3','P5','P6','S4','P7','ru32','ru38'].


## Statistics
- **4.0.process.colocated.data.py**
This script includes a series of functions for processing, selecting, and analyzing colocated data between steric and KaRIn. The analysis involves removing linear trends in space and time, selecting valid data based on time and spatial criteria, and visualizing various aspects of the colocated data. Below is a description of each function and its purpose.

### Example use:

.. code-block:: bash
    python 4.0.process.colocated.data.py 0 -500 100 9


.. code-block:: bash
    Parameters:
    0      : Integration depth at the top of the water column (in meters).
    -500   : Integration depth at the bottom of the water column (in meters).
    100    : Maximum allowable time difference between steric (mooring profile) and SWOT flyover time (in minutes).
    9      : Minimum number of valid points required to remove trends. Default is 5; 
             any snapshot with fewer than 5 points will be dropped.

1. **remove_trend(data, var_name, valid_points=5, temporal=True, spatial=True)**
   
   Removes the linear trend from the specified variable in the input data. The trend can be removed both temporally (along the time axis) and spatially (along the latitude). It handles missing values (NaNs). 
   
   Parameters:
   - `data`: A pandas DataFrame containing the data to be processed.
   - `var_name`: The name of the variable for which the trend is to be removed (e.g., 'steric_linear').
   - `valid_points`: Minimum number of valid points required to remove the trend.
   - `temporal`: Whether to remove the temporal trend (default is True).
   - `spatial`: Whether to remove the spatial trend (default is True).
   
   Returns:
   - The data with trends removed.

2. **select_along_karin_swath_center(df, dis=0.025)**
   
   Selects data points along the center of the SWOT satellite swath. The distance between the data points and the swath center is evaluated, and only those points within a given distance are selected. It is useful to select the gliders near the swath centers. It does not affect mooring data selection. 
   
   Parameters:
   - `df`: The input DataFrame containing the data to be processed.
   - `dis`: The maximum distance to the SWOT swath center, in degrees.
   
   Returns:
   - The subset of data points that are within the specified distance from the SWOT track.
   - The longitude and latitude of the SWOT track.

3. **select_colocated_data(dd, max_deltat_left, max_deltat_right, distance_to_center)**
   
   Selects colocated data based on criteria including maximum time difference between two datasets (steric and Karin) and the maximum distance to the center of the SWOT swath. This function filters the data according to the provided thresholds.

   Parameters:
   - `dd`: The input DataFrame with colocated data.
   - `max_deltat_left`: The maximum allowed time difference between SWOT time and the nearest mooring profile to the left (in minutes).
   - `max_deltat_right`: The maximum allowed time difference between SWOT time and the nearest mooring profile to the right (in minutes).
   - `distance_to_center`: The maximum allowed distance to the center of the SWOT swath (in degrees).

   Returns:
   - A DataFrame containing the selected colocated data.
   - Longitude and latitude of the SWOT track.

4. **plot_locations(dd, max_deltat_left=60, max_deltat_right=60, distance_to_center=0.02)**
   
   Plots the locations of the colocated data points, color-coded by their source (e.g., glider, P mooring, S mooring). The function also plots the positions of the SWOT satellite's swath.

   Parameters:
   - `dd`: The input DataFrame with colocated data.
   - `max_deltat_left`: The maximum time difference for data selection.
   - `max_deltat_right`: The maximum time difference for data selection.
   - `distance_to_center`: The maximum distance from the SWOT swath center.

   Returns:
   - A figure with the plotted locations of the colocated data and SWOT track.

5. **plot_latitudes(dd, max_deltat_left=60, max_deltat_right=60, distance_to_center=0.025)**

   Plots the latitudes of the colocated data over time. This helps in visualizing the temporal distribution of the data points.

   Parameters:
   - `dd`: The input DataFrame with colocated data.
   - `max_deltat_left`: The maximum time difference for filtering.
   - `max_deltat_right`: The maximum time difference for filtering.
   - `distance_to_center`: The maximum distance from the SWOT swath center.

   Returns:
   - A figure showing the latitudes of the colocated data over time.

6. **plot_profiles_space(dd, var_name='steric_linear')**

   Plots the spatial profiles of the colocated data for the specified variable. The spatial profiles are plotted for each unique time point in the dataset.

   Parameters:
   - `dd`: The input DataFrame with colocated data.
   - `var_name`: The name of the variable to plot (e.g., 'steric_linear').

   Returns:
   - A figure with the spatial profiles of the colocated data.

7. **plot_time_series(data0, var_name)**

   Plots time series of the mooring steric height and SWOT KaRIn SSHA.

   Parameters:
   - `data0`: The input DataFrame with colocated data.
   - `var_name`: The name of the variable to plot (e.g., 'steric_linear').

   Returns:
   - A figure with the time series plots for each mooring ID.

8. **error_stats(data, var_name, plotit=False)**

   Calculates error statistics (mean absolute difference, standard deviation, and RMSD) between the steric and SWOT data. Optionally, it also plots the error statistics.

   Parameters:
   - `data`: The input DataFrame with colocated data.
   - `var_name`: The name of the variable to compute statistics for (e.g., 'steric_linear').
   - `plotit`: Whether to plot the error statistics (default is False).

   Returns:
   - A DataFrame with the error statistics for each mooring.

9. **loop_over_parameters_for_stats()**

   Loops over various parameter combinations (e.g., depth, valid points, and time difference thresholds) to compute the colocated data statistics and save the results.



## Wavenumber Spectrum 
- **5.0.wavenumber_spectrum.py**

Wavenumber spectrum analysis 
